{% extends "ui-base.html" %}
{% block title %}Трекинг{% endblock %}


{% block css %}

    <!-- webix.css -->
    <link href="/static/libs/webix/codebase/webix.css" rel="stylesheet" type="text/css" >

    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap/latest/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />

	<!-- tracking.css -->
    <link href="/static/css/tracking.css" rel="stylesheet" type="text/css" >

	<!--left-menu.css-->
	<link href="/static/css/left-menu.css" rel="stylesheet" type="text/css" >

{% endblock %}



{% block js %}

	<!-- jQuery -->
	<script src="/static/libs/jquery-2.1.4.min.js"></script>
    
    <!-- Date Range Picker -->
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>

	<!-- tracking.js -->
    <script src="/static/js/tracking.js"></script>

    <!-- left_menu.js -->
    <script src="/static/js/left_menu.js"></script>

    <!-- Webix JS Core -->
    <script src="/static/libs/webix/codebase/webix.js"></script>

{% endblock %}



{% block webix_data %}

var menuData = {

	"leftMenuData": {{ left_menu_data|safe }},
	"leftMenuLinks": {{ left_menu_links|safe }}

};

var spIDData = {{ sp_id_data|safe }}

var contentData = {

	"toolbarDates": {{ toolbar_dates|safe }},

	"trackTreetableData": {{ treetable_data|safe }},

	"visitChartData": {{ views_chart_data|safe }},
	"visitChartLegendData": [{text:"Общее число посещений",color:"#a7ee70"},{text:"Уникальные поситители",color:"#36abee"}],
	//"visitChartYAxis":{{ views_chart_axis_steps|safe }},

	"timeChartData": {{ time_chart_data|safe }},
	"timeChartLegendData": [{text:"Среднее время на сайте",color:"#a7ee70"},{text:"Среднее время активности",color:"#36abee"}],
	//"timeChartYAxis": {{ time_chart_axis_steps|safe }},

};

{% endblock %}



{% block menu %}<div class="tracking-menu-inner-div" id="leftMenuContainerInner"></div>{% endblock %}

{% block content %}
    <div class="tracking-content-top-inner-div" id="contentContainerInnerTop">
        <div class="tracking-content-top-inner-div-calendar" id="contentContainerInnerTopCalendar">
            <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; width: auto">
                <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                <span></span> <b class="caret"></b>
            </div>
        </div>
        <div class="tracking-content-top-inner-div-webix" id="contentContainerInnerTopWebix"></div>
    </div>
    <div class="tracking-content-inner-div" id="contentContainerInner"></div>
{% endblock %}



{% block js_code %}

		var preloaderDelay = 20000;

		var currentSPID = contentData.trackTreetableData[0]["spID"];
		var currentSPKey = getSPQueryKey(contentData.trackTreetableData[0]["id"]);
		var currentName = contentData.trackTreetableData[0]["value"];

        var toDaysAgo = {{ to_days_ago|safe }};
        var fromDaysAgo = {{ from_days_ago|safe }};

		//Старт вебикса
		webix.ready(function () {
			buildLeftMenu(menuData, "leftMenuContainerInner", leftMenuClick);
			$$("leftMenuID").select(1);

			contentData["viewLabelText"] = "Количество посещений " + "«" + currentName + "»";
			contentData["timeLabelText"] = "Средняя длительность посещений " + "«" + currentName + "»" + " (сек.)";
			buildContentTop(0, "contentContainerInnerTopWebix", refreshClick);
            buildContentBase(contentData, "contentContainerInner", treetableClick);
			$$("trackTreetableID").select(1);
		});

        //Добавляем календарь
        buildCalendar("#reportrange", dateClick, fromDaysAgo, toDaysAgo)

		//Обработка нажатия на меню слева
		function leftMenuClick(itemID) {
			document.location.href = menuData.leftMenuLinks[itemID - 1]
		}

		//Обработка нажатия на выбор даты
		function dateClick(start, end) {
            toDaysAgo = moment().diff(end.startOf('day'), "days");
            fromDaysAgo = moment().diff(start.startOf('day'), "days");
            refreshClick();
		}

		//Обработка кнопки "обновить"
		function refreshClick() {
			loadRefresh(5);
			$$("trackTreetableID").showProgress({
				type:"bottom",
				delay:preloaderDelay,
				hide:false
			});

			$$("visitChartID").showProgress({
			   type:"icon",
			   delay:preloaderDelay
			});

			$$("timeChartID").showProgress({
			   type:"icon",
			   delay:preloaderDelay
			});
		}

		//Обработка выбора сайта из списка
		function treetableClick(itemID) {
			var spID = getSPIDByRow(itemID);
			if (spID) {
				if (spID != currentSPID) {
					loadSPData(getSPQueryKey(itemID), spID, 5)
					$$("trackTreetableID").showProgress({
						type:"bottom",
						delay:preloaderDelay,
						hide:false
					});

					$$("visitChartID").showProgress({
					   type:"icon",
					   delay:preloaderDelay
					});

					$$("timeChartID").showProgress({
					   type:"icon",
					   delay:preloaderDelay
					});
				}
			}
		}

		//Получение ID сайта или страницы (пикселя) на основе ID в списке treetable
		function getSPIDByRow(value) {
			return spIDData[value];
		}

		//Получение site_id или page_id для query string
		function getSPQueryKey(value) {
			return ["site_id", "page_id"][Number(value.indexOf(".") != -1)];
		}

		//Загрузка данных для графиков-хуяфиков и тритейбла, по нажатию "обновить"
		function loadRefresh(attempts) {
			if (attempts <= 0) {
				webix.alert("Упс.<br>Проверьте интернет соединение и нажмите «OK»", function(result){location.reload();});
				return;
			}
			var reqData = {};
				reqData["command"] = "get_refresh_data";
				reqData[currentSPKey] = currentSPID;
                reqData["to_days_ago"] = toDaysAgo;
                reqData["from_days_ago"] = fromDaysAgo;
			$.ajax({
				url: "/platform/tracking_ajax/",
				type: "get",
				data: reqData,
				success: function(response) {
					spUpdate(response);
					ttUpdate(response);
					spIDData = response.spIDData
					$$("trackTreetableID").hideProgress();
					$$("visitChartID").hideProgress();
					$$("timeChartID").hideProgress();
				},
				error: function(xhr) {
					loadRefresh(attempts - 1)
					$$("trackTreetableID").hideProgress();
					$$("visitChartID").hideProgress();
					$$("timeChartID").hideProgress();
				}
			});
		}

		//Загрузка данных для графиков-хуяфиков (Рекурсия)
		function loadSPData(spKey, spID, attempts) {
			if (attempts <= 0) {
				webix.alert("Упс.<br>Проверьте интернет соединение и нажмите «OK»", function(result){location.reload();});

				setVisibleWebixComponent("visitChartID", false);
				setVisibleWebixComponent("viewToolbarID", false);
				setVisibleWebixComponent("timeChartID", false);
				setVisibleWebixComponent("timeToolbarID", false);

				return;
			}
			var reqData = {};
				reqData["command"] = "get_data_by_sp_id";
				reqData[spKey] = spID;

			$.ajax({
				url: "/platform/tracking_ajax/",
				type: "get",
				data: reqData,
				success: function(response) {
					spUpdate(response);
					currentSPID = spID;
					currentSPKey = spKey
					$$("trackTreetableID").hideProgress();
					$$("visitChartID").hideProgress();
					$$("timeChartID").hideProgress();;
				},
				error: function(xhr) {
					loadSPData(spKey, spID, attempts - 1);
					$$("trackTreetableID").hideProgress();
					$$("visitChartID").hideProgress();
					$$("timeChartID").hideProgress();
				}
			});
		}

		//Вывод полученной инфы в гуй (графики-хуяфики)
		function spUpdate(dataJSON) {
			currentName = dataJSON.spName;

			var isVisible = dataJSON.visitChartData.length > 1;
			setVisibleWebixComponent("visitChartID", isVisible);
			setVisibleWebixComponent("viewToolbarID", isVisible);

			if (!isVisible) {
				webix.alert("Пока мы собрали<br>маловато данных.<br>Завтра будет больше!");
			}

			$$("visitChartID").clearAll();
			//$$("visitChartID").yAxis = dataJSON.visitChartYAxis;
			$$("visitChartID").parse(dataJSON.visitChartData)
			$$("visitChartID").refresh();
			$$("visitChartID").render();
			$$("viewToolbarLabelID").define("label", "Количество посещений " + "«" + currentName + "»");
			$$("viewToolbarLabelID").refresh();

			isVisible = dataJSON.timeChartData.length > 1;
			setVisibleWebixComponent("timeChartID", isVisible);
			setVisibleWebixComponent("timeToolbarID", isVisible);

			$$("timeChartID").clearAll();
			//$$("timeChartID").yAxis = dataJSON.timeChartYAxis;
			$$("timeChartID").parse(dataJSON.timeChartData);
			$$("timeChartID").refresh();
			$$("timeChartID").render();
			$$("timeToolbarLabelID").define("label", "Средняя длительность посещений " + "«" + currentName + "»" + " (сек.)");
			$$("timeToolbarLabelID").refresh();
		}

		//Вывод полученной инфы в гуй (тритейбл)
		function ttUpdate(dataJSON) {
			$$("trackTreetableID").parse(dataJSON.trackTreetableData);
		}

		//На кой хер эти господа из вебикс сделали методы show и hide? Лучше б что-нить типа visible...
		function setVisibleWebixComponent(compID, isVisible) {
			if (isVisible) {
				$$(compID).show();
			} else {
				$$(compID).hide();
			}
		}

{% endblock %}